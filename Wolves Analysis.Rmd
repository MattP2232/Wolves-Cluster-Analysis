---
title: "A Cluster Analysis of the Minnesota Timberwolves"
author:
- Matt Parker
- parke898@umn.edu
output:
  prettydoc::html_pretty:
    theme: leonids
---
<style>
pre code {
  color: #222;
}

body {
  font-size: 13pt;
}
</style>

<div style="text-align:center;">
  <img src="C:\Users\mattp\Documents\Timberwolves Project\Wolves Image.webp" width="600px">
  </div>
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

# Introduction

As the Timberwolves embark on what could possibly be their best regular season in franchise history, it’s hard not to reminisce on some of the players who brought us joy and anger (mostly anger) in some of our most excruciatingly painful seasons. In fact, I often ponder on the idea of former Wolves and the role they might have played in current iterations of the team. Using a statistical classification method called k-means clustering, we can do just that by grouping similar Wolves players together using various basketball statistics focused on advanced algorithms and player tendencies. 

In this project, I’ll be going over the use and implementation of k-means clustering, the data sets and how they were collected / manipulated, and finally the visualization of our k-means cluster plots that split our observations into nine distinct groups.

In addition to breaking down the steps of my analysis, I'll provide footnotes with links to my code to ensure this project is a replicable as possible. We'll start with a link to the required packages for my statistical analysis and visualization here[^1].

[^1]: [Required Packages](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

## Library

Below are the packages required for my analysis.

```{r}
suppressMessages({
library(DBI)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(knitr)
library(RColorBrewer)
library(cluster)  
library(factoextra)
library(grid)
library(png)
library(knitr)
})

suppressWarnings({
library(RODBC)
library(odbc)
library(gghighlight)
library(DT)
library(huxtable)
library(kableExtra)
})
```

```{r, eval = TRUE, echo = FALSE}
con <- dbConnect(RMySQL::MySQL(), 
                 dbname = "timberwolves",
                 host = "localhost",
                 port = 3306,
                 user = "root",
                 password = "Timberwolves1332")
```

# K-Means Clustering: Calculations and Steps for Clustering the Data Set

K-means clustering is an unsupervised statistical method focused on splitting observations into subgroups, where the observations in each subgroup exhibit similarities to each other based on the values of their predictor variables. When we say a statistical method is unsupervised, this implies that there is no response variable present in the data set, so our variables won’t be used to make predictions.

The idea of k-means is to create a set number of clusters so the total within-cluster variation is minimized. The algorithm we’ll use to create our clusters, which is visualized below, is calculated as the sum of squared distances between observations and the mean of observations within each cluster, otherwise known as the centers.

```{r echo=FALSE, out.width = "30%", fig.align = "center"}
knitr::include_graphics("~/Timberwolves Project/K-means 1.JPG")
```

Here, x<sub>i</sub> is defined as a data point within cluster C<sub>k</sub>, while u<sub>k</sub> is the mean of all data points within C<sub>k</sub>. Ultimately our goal is to minimize the total within cluster sum of squares algorithm, visualized below.

```{r echo=FALSE, out.width = "30%", fig.align = "center"}
knitr::include_graphics("~/Timberwolves Project/K-means 2.JPG")
```
	
In creating our k-means algorithm, several steps are involved in optimizing statistical performance and minimizing within cluster variation. First off, we initialize the number of clusters to be created, which we define as k. From there, we randomly select k observations from our data set and initialize these points as our cluster centers (or means). We’ll follow by assigning observations to their closest cluster, while updating our cluster centers as new observations are assigned. In our analysis, we will create 25 initial configurations of our model, which is recommended in k-means clustering, and report on the best model.

What we should ideally produce is a set number of clusters where our observations, or in this case our players, have similar playing styles and player performance based on their statistics encompassed over a single season of play. Ultimately, some players may be placed in clusters that don’t necessarily align with our perceived notion of their performance, since we’re only considering x number of statistics that have various flaws in their own right. With that said, our k-means clusters should produce some fun visuals that highlight similarities that various Wolves players exhibited over the years.

# The Dataset

Our data set will encompass all Minnesota Timberwolves players who have played a minimum of 500 minutes in a season since 2012-2013. I wanted to create a relatively large data set while including only those players who made an impact on the floor (bad or good), and 500 minutes felt like the appropriate cutoff for that description. Though 138 individual player seasons were included in the data set, 63 of those come from unique players, so it’s worth noting that there will be duplicates of players from different seasons.

The player statistics were taken from Basketball Reference, using basic and advanced stats tables from 2012 up until 2024. The data sets used in analysis were wrangled together using MySQL, which involved joining basic and advanced stat tables together and eliminating all variables that wouldn’t be present in analysis outside of player names, seasons, and minutes played. The data was then exported to R where I began my analysis.

```{r}
wolves_data <- dbReadTable(con, "wolves_data")
mm <- dbReadTable(con, "m_morris")
```

## Variables

Below is a list of all variables present in our cluster analysis, split by tendency stats and advanced stats. All stats and descriptions are provided by Basketball Reference.

### Tendency Statistics

* 3PAr -- 3-Point Attempt Rate: Percentage of FG Attempts from 3-Point Range
* FTr -- Free Throw Attempt Rate: Number of FT Attempts Per FG Attempt
* ORB% -- Offensive Rebound Percentage: An estimate of the percentage of available offensive rebounds a player grabbed while they were on the floor.
* DRB% -- Defensive Rebound Percentage: An estimate of the percentage of available defensive rebounds a player grabbed while they were on the floor.
* AST% -- Assist Percentage: An estimate of the percentage of teammate field goals a player assisted while they were on the floor.
* STL% -- Steal Percentage: An estimate of the percentage of opponent possessions that end with a steal by the player while they were on the floor.
* BLK% -- Block Percentage: An estimate of the percentage of opponent two-point field goal attempts blocked by the player while they were on the floor.
* TOV% -- Turnover Percentage: An estimate of turnovers committed per 100 plays.
* USG% -- Usage Percentage: An estimate of the percentage of team plays used by a player while they were on the floor.

### Advanced Statistics

* WS/48 -- Win Shares Per 48 Minutes: An estimate of the number of wins contributed by a player per 48 minutes (league average is approximately .100)
* OBPM -- Offensive Box Plus/Minus: A box score estimate of the offensive points per 100 possessions a player contributed above a league-average player, translated to an average team.
* DBPM -- Defensive Box Plus/Minus: A box score estimate of the defensive points per 100 possessions a player contributed above a league-average player, translated to an average team.
* VORP -- Value over Replacement Player: A box score estimate of the points per 100 TEAM possessions that a player contributed above a replacement-level (-2.0) player, translated to an average team and prorated to an 82-game season.

<div style="margin-bottom: 25px;"></div>

In conducting my analysis, I was looking for a set of variables that would account for play style as well as player performance. I decided not to include basic counting stats like points, rebound, assists, etc so we could more easily compare players who play significant minutes and those who don’t, while instead opting for a collection of advanced stats to quantify performance. These advanced metrics are far from perfect, so keep that in mind when considering how each player is categorized.

Tendency stats should provide a glimpse into how players can be categorized into specific overarching play styles. For example, Luke Ridnour and Nikola Pekovic may exhibit similar advanced numbers quantifying performance, but they’re on opposite sides of the spectrum when it comes to their style of play. These statistics should assist in categorizing players who play similar styles of basketball. In addition, I believe tendency stats aren’t significantly swayed by volume, or in this case minutes played, as players tend to play the same style of basketball no matter how often they see the court.

## Data Manipulation

Below is our complete set of unique Timberwolves players who have logged at least 500 minutes in a season since the 2012, with the code for filtering the data set here[^2].

[^2]: [Filtering Wolves Data Set](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

```{r}
# Filtering for players who player at least 500 minutes

wolves_500 <- subset(wolves_data, MP > 500)
unique_players <- unique(wolves_500$Player)

suppressWarnings({
m <- as.data.frame(matrix(unique_players, ncol = 5, byrow = TRUE))
})

names(m) <- NULL
m[13, 4] <- ""
m[13, 5] <- ""

m_html <- kable(m, "html") %>%
  kable_styling()

m_html
```

After filtering for players with greater than 500 minutes played, we need to extract the predictor variables from the data set used in our analysis, which is shown here[^3].

[^3]: [Extracting Predictor Variables](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

One additional note to keep in mind is on turnover percentage (TO%). Without making any changes to the data set, a player with a low turnover percentage would have a scaled TO% value below zero. Considering a low turnover percentage is a positive for player performance, I decided to change the TO% values to negative values to flip them across the mean. In doing so, players with low turnover percentages will now have positive scaled values.

```{r}
# Extracting predictor variables

wolves_data_1 <- wolves_500[, c(4:13, 17:20)]
wolves_data_1$TOV. <- -wolves_data_1$TOV.
scaled_wolves <- scale(wolves_data_1)
```

# K-Means Clustering: Algorithm and Optimal Number of Clusters

Before we develop our k means algorithm, we must determine the optimal number of clusters for analysis. In doing so, we will calculate our clustering algorithm at a specific value of k, with k being the number of clusters, and determine the within cluster variation at each value of k. We’ll then plot each within cluster variation value and determine the optimal number of clusters using this plot. The code for this process can be found here[^4]. 

[^4]: [Algorithm and Optimal Number of Clusters](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

Usually, we choose the number of clusters where the decrease in within cluster variation is minimal or there is a noticeable elbow in the plot. Below is our plot for cluster optimization, where I ultimately choose nine as the ideal number of clusters.

```{r}
# Determining the optimal number of clusters using fviz_nbclust function

oc <- fviz_nbclust(scaled_wolves, kmeans, method = "wss")
oc
```

```{r}
# Running the model
  
set.seed(2024)

K <- 9
kmeans9 <- kmeans(scaled_wolves, centers = K, nstart = 25, iter.max = 20)
km_centers <- as.data.frame(kmeans9$centers) 

# Name clusters before pivoting

km_centers$Cluster <- c('Cluster 1', 'Cluster 2', 'Cluster 3',
                       'Cluster 4', 'Cluster 5', 'Cluster 6',
                       'Cluster 7', 'Cluster 8', 'Cluster 9') 

# Pivot data to make plotting easier

km_centers <- km_centers %>% 
  rename(c('AST%' = 'AST.', 'DRB%' = 'DRB.', 'ORB%' = 'ORB.', 
           'BLK%' = 'BLK.', 'STL%' = 'STL.', 'TOV%' = 'TOV.', 
           'USG%' = 'USG.', 'TS%' = 'TS.', '3PAr' = 'X3PAr')) %>%
  pivot_longer(!Cluster, names_to = 'predictor', values_to = 'z_value')

# Reset the order of clusters for plotting

km_centers$Cluster <- factor(km_centers$Cluster, 
                             levels=c('Cluster 1', 'Cluster 2', 'Cluster 3', 
                                      'Cluster 4', 'Cluster 5', 'Cluster 6', 
                                      'Cluster 7', 'Cluster 8', 'Cluster 9'))
```

# Visualizing K-Means Clusters

Finally, our analysis and visualization. I created a for loop that would visualize all nine clusters and the players present within each cluster. For the sake of a cleaner visual, I decided to put the centers (or means) of each variable in descending order to highlight the skills that the players in each cluster excelled in, or didn't excel in. This means that the variables on the x axis won’t be in the same order across plots, so keep that in mind when analyzing the plots. In addition, I created an if statement within the loop to remove duplicate names if a cluster exceeded 15 player seasons to avoid overfilling the tables. For example, cluster one will have duplicate players, while cluster three won’t due to the number of players present in the cluster.

Below are the visuals of all 9 clusters, labeled by what I determined to be a proper group name given their cluster centers and the players present (but it’s up for interpretation!). What you'll see is the average value of each statistic, scaled to the rest of the data set, for all players present in the cluster.

In addition, I'll provide the initial function to arrange the first ggplot with the table of players present in the cluster, but hide the other eight to avoid repetition. The code for visualizing k-means clusters can be found here[^5].

[^5]: [Visualizing K-Means](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

```{r}
# Create list of player images for each graph

ip <- c("~/Timberwolves Project/Ricky.png", "~/Timberwolves Project/Jaden.png", "~/Timberwolves Project/Pek2.png", "~/Timberwolves Project/Brew.png", "~/Timberwolves Project/Mo.png", "~/Timberwolves Project/AB.png", "~/Timberwolves Project/Ant.png", "~/Timberwolves Project/KAT.png", "~/Timberwolves Project/Bazz.png")

max_rows <- 9
gg_list <- list()
clp_list <- list()

# Additional names for clusters, color of centers in each graph, and cluster names

cluster <- c('Cluster 1', 'Cluster 2', 'Cluster 3', 'Cluster 4',
            'Cluster 5', 'Cluster 6', 'Cluster 7', 'Cluster 8', 
            'Cluster 9')

cluster_numbers <- c(1:9)

wolves_colors <- c("#253494", "#1A9850", "#4D4D4D", "#66BD63", 
                   "#225EA8", "#081D58", "black", "#253494", "#1A9850")

wolves_colors_alpha <- adjustcolor(wolves_colors, alpha.f = 0.25)

cluster_names <- c("Ricky Rubio", "3&D", "Classic Bigs", "Ball Movement and Defense", "One-Way Combo Guards", "The Wolves Experience", "All-Around Players", "Superstar Offensive Bigs", "High Volume Scorers")

# For loop for outputs of ggplots and player name tables

for(i in seq_along(cluster)) {
  char <- cluster[i]
  num <- cluster_numbers[i]
  wc <- wolves_colors[i]
  wc_2 <- wolves_colors_alpha[i]
  cn <- cluster_names[i]
  #img <- readPNG(ip[i])
  #img_grob <- rasterGrob(img, interpolate = TRUE, width = unit(1.5, "inches"))
  
  cluster_loop <- km_centers %>% 
    filter(Cluster == char) %>%
    arrange(desc(z_value)) %>%
    ggplot(aes(x = reorder(predictor, -z_value), y = z_value, color = Cluster)) + 
    geom_point(color = wc, size = 2) +
    gghighlight(Cluster == char, use_direct_label = FALSE) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey", linewidth = 0.75) +  
    labs(x = "Player Statistics", y = "Cluster Center", title = cn, subtitle = char) +  
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, size=10),
          plot.title = element_text(face = "bold")) +
    scale_y_continuous(breaks = seq(-3, 3, by = 1)) +
    #annotation_custom(img_grob, xmin = Inf, xmax = 10, ymin = Inf, ymax = Inf) +
    coord_cartesian(ylim = c(-3, 3), clip = "off") 
  
  gg_list[[i]] <- cluster_loop

  
  cluster_loop_players <- data.frame(Cluster = kmeans9$cluster, 
                                     Name = wolves_500$Player, 
                                     Season = wolves_500$Year) %>%
                                          filter(Cluster == num)

  if(nrow(cluster_loop_players) > 15) {
    sub_players <- distinct(cluster_loop_players, Name, .keep_all = TRUE)
  }
  else {
    sub_players <- cluster_loop_players
  }

  tab_play <- tableGrob(sub_players[, 2:3], rows = NULL, theme = 
                          ttheme_default(core = list(bg_params = list(fill = wc_2))))
  
  clp_list[[i]] <- tab_play
}
```

```{r}
grid.arrange(gg_list[[1]], clp_list[[1]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[2]], clp_list[[2]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[3]], clp_list[[3]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[4]], clp_list[[4]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[5]], clp_list[[5]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[6]], clp_list[[6]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[7]], clp_list[[7]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[8]], clp_list[[8]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 75px;"></div>

```{r, eval = TRUE, echo = FALSE}
grid.arrange(gg_list[[9]], clp_list[[9]], layout_matrix = rbind(c(1, 2)))
```

<div style="margin-bottom: 25px;"></div>

# Predicting New Observations: Monte Morris

Lastly, I wanted to take a look at recently acquired point guard Monte Morris, with the goal of comparing his career numbers to the nine clusters created in our k-means algorithm. I collected Monte’s career numbers and scaled them relative to the rest of our database.

```{r}
# Scale the Monte Morris data frame using the means and standard deviations

mm$TOV. <- -mm$TOV.

means <- colMeans(wolves_data_1)

sds <- apply(wolves_data_1, 2, sd)

scaled_mm <- as.data.frame(scale(mm, center = means, scale = sds))

scaled_mm <- scaled_mm %>% 
  rename(c('AST%' = 'AST.', 'DRB%' = 'DRB.', 'ORB%' = 'ORB.', 
           'BLK%' = 'BLK.', 'STL%' = 'STL.', 'TOV%' = 'TOV.', 
           'USG%' = 'USG.', 'TS%' = 'TS.', '3PAr' = 'X3PAr'))

long_data <- gather(scaled_mm, key = "x", value = "y")
```

From there, I calculated the sum of square differences between Monte’s numbers and the cluster centers within each cluster. Below is a table containing these sum of square differences between Monte and all nine clusters, with the code provided here[^6]

[^6]: [Morris Data and Cluster Assignment](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

```{r}
# Assign the new observation to the cluster with the minimum distance

set.seed(2024)

distances <- apply(kmeans9$centers, 1, function(center) sqrt(sum((scaled_mm - center)^2)))
s <- t(as.matrix(distances))
as.data.frame(s)
```

Based on the results above, Monte would fall under cluster three, the 3&D group. With that said, I found the other results more eye opening, particularly Monte’s distinct difference from former Wolves point guard Ricky Rubio. Outside of the Ricky cluster, the only other cluster Monte was least similar to was the Superstar Offensive Bigs cluster, which is to be expected given the differences in play style and performance between a backup guard like Morris and the players in this cluster. So why are two point guards like Ricky and Monte so distinct from each other? Below is a plot of our Ricky Rubio cluster with our Monte Morris statistics added on as a means of comparison, with the code provided here[^7]

[^7]: [Ricky vs. Monte Visual](https://github.com/MattP2232/STAT4052-Project/blob/main/R%20Code/4052%20Final%20Project.Rproj)

```{r}
# Morris and Rubio player photos

img_2 <- readPNG("~/Timberwolves Project/Monte.png")
#img_grob_2 <- rasterGrob(img_2, interpolate = TRUE, width = unit(1.5, "inches"))
img_3 <- readPNG("~/Timberwolves Project/Ricky.png")
#img_grob_3 <- rasterGrob(img_3, interpolate = TRUE, width = unit(1.5, "inches"))
```

```{r}
# Ricky and Monte Player Table

mm2 <- data.frame(Name = "Monte Morris", Season = "Career")
column_widths <- unit(c(3, 3), "cm")

monte_grob <- tableGrob(mm2, rows = NULL, 
                      theme = ttheme_default(core = list(bg_params = list(fill = adjustcolor("#253494", alpha.f = 0.25)))), 
                      widths = column_widths)

ricky <- data.frame(Cluster = kmeans9$cluster,
                    Name = wolves_500$Player, 
                    Season = wolves_500$Year) %>%
                        filter(Cluster == 1)

ricky_grob <- tableGrob(ricky[, 2:3], rows = NULL, 
                      theme = ttheme_default(core = list(bg_params = list(fill = adjustcolor("red", alpha.f = 0.25)))), 
                      widths = column_widths)

combined_table <- rbind(ricky_grob, monte_grob[2, ], size = "last")
```

```{r, fig.width=15, fig.height=6}
# Ricky vs. Monte Visual

suppressWarnings({
  ricky_monte <- km_centers %>% 
    filter(Cluster == "Cluster 1") %>%
    arrange(desc(z_value)) %>%
    ggplot(aes(x = reorder(predictor, -z_value), y = z_value, color = Cluster)) + 
    geom_point(color = "red", size = 2) +
    geom_point(data = long_data, aes(x = x, y = y), color = "#253494", size = 2) +
    gghighlight(Cluster == "Cluster 1", use_direct_label = FALSE) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey", linewidth = 0.75) +  
    labs(x = "Player Statistics", y = "Cluster Center", 
       title = "Ricky Rubio vs. Monte Morris", 
       subtitle = "Cluster 1 Against Scaled Morris Statistics") +  
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, size=10),
          plot.title = element_text(face = "bold"), plot.margin = ) +
    scale_y_continuous(breaks = seq(-3, 3, by = 1)) +
    #annotation_custom(img_grob_2, xmin = Inf, xmax = 10, ymin = Inf, ymax = 2) +
    #annotation_custom(img_grob_3, xmin = Inf, xmax = 4, ymin = Inf, ymax = 2.06) +
    coord_cartesian(ylim = c(-3, 3), clip = "off") 
})

suppressWarnings({
  monte <- long_data %>% 
    ggplot(aes(x = reorder(x, y, decreasing = TRUE), y = y)) + 
    geom_point(color = "red", size = 2) +
    geom_point(data = long_data, aes(x = x, y = y), color = "#253494", size = 2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey", linewidth = 0.75) +  
    labs(x = "Player Statistics", y = "Scaled Morris Values", 
       title = "Monte Morris Career Statistics", 
       subtitle = "Scaled Relative to Timberwolves Data Set") +  
    theme_minimal() +
    theme(axis.text.x = element_text(angle=45, size=10),
          plot.title = element_text(face = "bold"), plot.margin = ) +
    scale_y_continuous(breaks = seq(-3, 3, by = 1)) +
    #annotation_custom(img_grob_2, xmin = Inf, xmax = 10, ymin = Inf, ymax = 2) +
    coord_cartesian(ylim = c(-3, 3), clip = "off") 
})
cluster_grids <- grid.arrange(monte, combined_table, ricky_monte, ncol = 3)
```

<div style="margin-bottom: 25px;"></div>

What we can see are some strong differences between Ricky’s play style and performance and Monte’s. The first four variables, AST%, TOV%, STL%, and FTr are where we see particularly stark differences between the two players. To me, this falls in line with the modern sentiment of positionality and its lack of correlation with play style. Ricky falls in line with the traditional point guard in terms of play style; someone who quarterbacks the offense and hounds perimeter defenders. Monte, on the other hand, plays the role as a connector; someone who takes care of the ball and spaces the floor, which fit particularly well for several years as a complimentary piece to a Nikola Jokic led Nuggets team.

<div style="margin-bottom: 25px;"></div>



